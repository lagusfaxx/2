generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  STAFF
  SUPPORT
}

enum ProfileType {
  VIEWER
  CREATOR
  PROFESSIONAL
  SHOP
}

enum CategoryType {
  PROFESSIONAL
  ESTABLISHMENT
}

enum PlanTier {
  PREMIUM
  GOLD
  SILVER
}

enum ServiceStatus {
  PENDING_APPROVAL
  ACTIVE
  PENDING_EVALUATION
  FINISHED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PreferenceGender {
  MALE
  FEMALE
  ALL
  OTHER
}

enum PaymentStatus {
  PENDING
  VERIFYING
  PAID
  FAILED
}

enum MediaType {
  IMAGE
  VIDEO
}

enum PostType {
  IMAGE
  VIDEO
}

enum NotificationType {
  SUBSCRIPTION_STARTED
  SUBSCRIPTION_RENEWED
  MESSAGE_RECEIVED
  POST_PUBLISHED
  SERVICE_PUBLISHED
}

enum PaymentIntentPurpose {
  CREATOR_SUBSCRIPTION
  SHOP_PLAN
}

enum PaymentIntentStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}

model User {
  id                  String            @id @default(uuid()) @db.Uuid
  email               String            @unique
  username            String            @unique
  passwordHash        String
  displayName         String?
  phone               String?
  gender              Gender?
  preferenceGender    PreferenceGender?
  profileType         ProfileType       @default(VIEWER)
  categoryId          String?           @db.Uuid
  planId              String?           @db.Uuid
  isActive            Boolean           @default(true)
  isOnline            Boolean           @default(false)
  anonymousMode       Boolean           @default(false)
  address             String?
  city                String?
  latitude            Float?
  longitude           Float?
  avatarUrl           String?
  coverUrl            String?
  bio                 String?
  serviceCategory     String?
  serviceDescription  String?
  subscriptionPrice   Int?              @default(2500)
  shopTrialEndsAt     DateTime?
  termsAcceptedAt     DateTime?
  allowFreeMessages   Boolean           @default(false)
  role                Role              @default(USER)
  membershipExpiresAt DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  posts                    Post[]
  payments                 Payment[]
  subscriptions            KhipuSubscription[]
  profileSubscriptions     ProfileSubscription[] @relation("ProfileSubscriptions")
  profileSubscriptionsByMe ProfileSubscription[] @relation("ProfileSubscriber")
  services                 ServiceItem[]
  profileMedia             ProfileMedia[]
  paymentIntents           PaymentIntent[]       @relation("SubscriberPaymentIntents")
  profilePaymentIntents    PaymentIntent[]       @relation("ProfilePaymentIntents")
  sentMessages             Message[]             @relation("SentMessages")
  receivedMessages         Message[]             @relation("ReceivedMessages")
  receivedRatings          ServiceRating[]       @relation("ProfileRatings")
  givenRatings             ServiceRating[]       @relation("GivenRatings")
  notifications            Notification[]
  category                 Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  plan                     Plan?                 @relation(fields: [planId], references: [id], onDelete: SetNull)
  professionalRatings      RatingProfessional[]  @relation("ProfessionalRatings")
  establishmentOwner       Establishment[]       @relation("EstablishmentOwner")
  establishmentRatings     RatingEstablishment[] @relation("EstablishmentRatings")
  favorites                FavoriteProfessional[] @relation("FavoriteOwner")
  favoriteOf               FavoriteProfessional[] @relation("FavoriteTarget")
  serviceRequestsAsClient  ServiceRequest[]      @relation("ServiceClient")
  serviceRequestsAsPro     ServiceRequest[]      @relation("ServiceProfessional")
  profileViews             ProfileView[]         @relation("ProfileViews")
  profilesViewed           ProfileView[]         @relation("ProfileViewed")
  featuredProfiles         FeaturedProfile[]
  auditLogs                AuditLog[]
}

model Post {
  id        String   @id @default(uuid()) @db.Uuid
  authorId  String?  @db.Uuid
  title     String
  body      String
  isPublic  Boolean  @default(false)
  price     Int      @default(0)
  type      PostType @default(IMAGE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User?  @relation(fields: [authorId], references: [id], onDelete: SetNull)
  media  Media[]
}

model Media {
  id        String    @id @default(uuid()) @db.Uuid
  postId    String    @db.Uuid
  type      MediaType
  url       String
  createdAt DateTime  @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Payment {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String        @db.Uuid
  khipuPaymentId   String?       @unique
  amount           Int
  status           PaymentStatus @default(PENDING)
  membershipDays   Int           @default(30)
  paymentUrl       String?
  paidAt           DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model KhipuSubscription {
  id                 String        @id @default(uuid()) @db.Uuid
  userId             String        @db.Uuid
  khipuSubscriptionId String?      @unique
  status             PaymentStatus @default(PENDING)
  amount             Int
  frequency          String        @default("MONTHLY")
  nextPaymentDate    DateTime?
  subscriptionUrl    String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfileSubscription {
  id           String   @id @default(uuid()) @db.Uuid
  subscriberId String   @db.Uuid
  profileId    String   @db.Uuid
  status       String   @default("ACTIVE")
  price        Int
  startedAt    DateTime @default(now())
  expiresAt    DateTime

  subscriber User @relation("ProfileSubscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  profile    User @relation("ProfileSubscriptions", fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, profileId])
}

model ServiceItem {
  id          String   @id @default(uuid()) @db.Uuid
  ownerId     String   @db.Uuid
  title       String
  description String?
  category    String?
  price       Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  media ServiceMedia[]
}

model ProfileMedia {
  id        String    @id @default(uuid()) @db.Uuid
  ownerId   String    @db.Uuid
  type      MediaType
  url       String
  createdAt DateTime  @default(now())

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model ServiceMedia {
  id            String    @id @default(uuid()) @db.Uuid
  serviceItemId String    @db.Uuid
  type          MediaType
  url           String
  createdAt     DateTime  @default(now())

  serviceItem ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @db.Uuid
  type      NotificationType
  data      Json?
  readAt    DateTime?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PaymentIntent {
  id                String               @id @default(uuid()) @db.Uuid
  subscriberId      String               @db.Uuid
  profileId         String?              @db.Uuid
  purpose           PaymentIntentPurpose
  status            PaymentIntentStatus  @default(PENDING)
  amount            Int
  providerPaymentId String?
  paymentUrl        String?
  paidAt            DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  subscriber User  @relation("SubscriberPaymentIntents", fields: [subscriberId], references: [id], onDelete: Cascade)
  profile    User? @relation("ProfilePaymentIntents", fields: [profileId], references: [id], onDelete: SetNull)
}

model Message {
  id        String    @id @default(uuid()) @db.Uuid
  fromId    String    @db.Uuid
  toId      String    @db.Uuid
  body      String
  createdAt DateTime  @default(now())
  readAt    DateTime?

  from User @relation("SentMessages", fields: [fromId], references: [id], onDelete: Cascade)
  to   User @relation("ReceivedMessages", fields: [toId], references: [id], onDelete: Cascade)
}

model ServiceRating {
  id        String   @id @default(uuid()) @db.Uuid
  profileId String   @db.Uuid
  raterId   String   @db.Uuid
  rating    Int
  createdAt DateTime @default(now())

  profile User @relation("ProfileRatings", fields: [profileId], references: [id], onDelete: Cascade)
  rater   User @relation("GivenRatings", fields: [raterId], references: [id], onDelete: Cascade)

  @@unique([profileId, raterId])
}

model Category {
  id        String       @id @default(uuid()) @db.Uuid
  name      String
  type      CategoryType
  iconUrl   String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  profiles       User[]
  establishments Establishment[]
}

model Plan {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  tier        PlanTier
  price       Int
  badgeColor  String?
  description String?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  profiles User[]
}

model Establishment {
  id          String    @id @default(uuid()) @db.Uuid
  ownerId     String?   @db.Uuid
  name        String
  city        String?
  address     String?
  phone       String?
  description String?
  latitude    Float?
  longitude   Float?
  categoryId  String?   @db.Uuid
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  owner       User?                @relation("EstablishmentOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  category    Category?            @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  media       EstablishmentMedia[]
  ratings     RatingEstablishment[]
}

model EstablishmentMedia {
  id              String    @id @default(uuid()) @db.Uuid
  establishmentId String    @db.Uuid
  type            MediaType
  url             String
  createdAt       DateTime  @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
}

model FavoriteProfessional {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @db.Uuid
  professionalId String   @db.Uuid
  createdAt      DateTime @default(now())

  user         User @relation("FavoriteOwner", fields: [userId], references: [id], onDelete: Cascade)
  professional User @relation("FavoriteTarget", fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([userId, professionalId])
}

model ServiceRequest {
  id             String        @id @default(uuid()) @db.Uuid
  clientId       String        @db.Uuid
  professionalId String        @db.Uuid
  status         ServiceStatus @default(PENDING_APPROVAL)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  approvedAt     DateTime?
  finishedAt     DateTime?

  client       User @relation("ServiceClient", fields: [clientId], references: [id], onDelete: Cascade)
  professional User @relation("ServiceProfessional", fields: [professionalId], references: [id], onDelete: Cascade)
}

model RatingProfessional {
  id             String   @id @default(uuid()) @db.Uuid
  professionalId String   @db.Uuid
  clientId       String   @db.Uuid
  rating         Int
  comment        String?
  createdAt      DateTime @default(now())

  professional User @relation("ProfessionalRatings", fields: [professionalId], references: [id], onDelete: Cascade)
  client       User @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([professionalId, clientId])
}

model RatingEstablishment {
  id              String   @id @default(uuid()) @db.Uuid
  establishmentId String   @db.Uuid
  clientId        String   @db.Uuid
  rating          Int
  comment         String?
  createdAt       DateTime @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  client        User          @relation("EstablishmentRatings", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([establishmentId, clientId])
}

model Banner {
  id        String   @id @default(uuid()) @db.Uuid
  title     String
  imageUrl  String
  linkUrl   String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FeaturedProfile {
  id        String   @id @default(uuid()) @db.Uuid
  profileId String   @db.Uuid
  rank      Int      @default(0)
  createdAt DateTime @default(now())

  profile User @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Country {
  code      String   @id
  name      String
  createdAt DateTime @default(now())

  regions Region[]
}

model Region {
  id          String   @id @default(uuid()) @db.Uuid
  countryCode String
  name        String
  createdAt   DateTime @default(now())

  country Country @relation(fields: [countryCode], references: [code], onDelete: Cascade)
}

model ProfileView {
  id        String   @id @default(uuid()) @db.Uuid
  viewerId  String   @db.Uuid
  profileId String   @db.Uuid
  createdAt DateTime @default(now())

  viewer  User @relation("ProfileViews", fields: [viewerId], references: [id], onDelete: Cascade)
  profile User @relation("ProfileViewed", fields: [profileId], references: [id], onDelete: Cascade)

  @@index([viewerId, createdAt])
  @@index([profileId, createdAt])
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  adminId   String   @db.Uuid
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)
}
